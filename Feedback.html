<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link id="favicon" rel="icon" href="./assets/favicon.png">

  <!-- =================================================================================== -->
  <!-- =========================== CONFIGURATION DE L'APPLICATION ====================== -->
  <!-- =================================================================================== -->
  <script id="app-config">
    /*
     * Configurez votre application ici.
     */
    window.APP_CONFIG = {
      // --- Backend URL ---
      // CORRECTION: Assurez-vous que c'est la bonne URL de votre Script A (Receiver) déployé
      WEBAPP_URL: "https://script.google.com/macros/s/AKfycbxRz2Od1d82fQfik128ijnuCJ4LWkRWDMW8lKZqqt9HX52NINWXoU-LcfuJo7tzENY/exec", // VOTRE URL RECEIVER

      // --- Branding ---
      BRAND: {
        TITLE: "Feedback CHOPS v21", // Gardé votre titre
        LOGO_URL: "./CHOPStandard.svg",
        MARK_URL: "./CHOPiBasic.svg",
        FAVICON_URL: "./CHOPiBasic.svg"
      },

      // --- Limites d'enregistrement ---
      LIMITS: {
        MAX_SECONDS: 120, // 2 minutes
        MAX_BYTES: 10 * 1024 * 1024, // 10MB
      },

      // --- Questions (Inchangé) ---
      QUESTIONS: {
        etudiant: { declic: "En tant qu'étudiant, quel a été le 'déclic' ou le moment 'aha' où vous avez saisi l'utilité de CHOPS ?", usage: "Comment avez-vous concrètement utilisé CHOPS ou CHOPi pour un projet académique ou personnel ?", clarte: "Qu'est-ce qui a le plus clarifié votre compréhension du framework ? (ex: un cours, un exemple, CHOPi...)", equipe: "Si vous l'avez utilisé en groupe, comment CHOPS a-t-il structuré vos échanges ou votre travail d'équipe ?", CHOPi: "Dans votre parcours d'apprentissage, qu'est-ce qui vous a plu ou manqué dans l'outil CHOPi ?", reutilisation: "Pensez-vous réutiliser CHOPS à l'avenir ? Si oui, dans quel type de projet ou de contexte ?", libre: "Vous avez la parole : quel est le retour le plus important que vous aimeriez nous donner ?" },
        entrepreneur: { declic: "En tant qu'entrepreneur, quel problème concret pensiez-vous résoudre ou quel 'déclic' avez-vous eu avec CHOPS ?", usage: "Comment avez-vous appliqué CHOPS ou CHOPi sur un de vos projets ou 'use case' d'entreprise ?", clarte: "Qu'est-ce qui, dans le framework, a le plus aidé à clarifier votre vision stratégique ou celle de vos équipes ?", equipe: "Comment vos équipes (ou vous-même) ont-elles interagi avec la méthode ? Quels ont été les points de friction ou de fluidité ?", CHOPi: "En tant que décideur, qu'avez-vous pensé de l'outil CHOPi ? Qu'est-ce qui lui manque pour être un outil pro ?", reutilisation: "Voyez-vous un potentiel de réutilisation de CHOPS pour d'autres 'use cases' dans votre organisation ?", libre: "Vous avez la parole : quel est le retour leF plus stratégique que vous aimeriez nous donner ?" },
        freelance: { declic: "En tant que freelance, quel a été le 'déclic' où vous vous êtes dit 'tiens, CHOPS pourrait m'aider avec mes clients' ?", usage: "Avez-vous pu utiliser CHOPS ou CHOPi (même mentalement) pour cadrer la mission d'un client ou un projet personnel ?", clarte: "Quelle partie du framework vous semble la plus utile pour structurer et vendre vos prestations de conseil ou de production ?", equipe: "En travaillant (souvent seul ou en petite équipe), comment CHOPS vous aide-t-il à mieux dialoguer avec vos clients/partenaires ?", CHOPi: "En tant qu'indépendant, que vous a-t-il plu ou manqué dans l'outil CHOPi pour vos propres besoins ?", reutilisation: "Pensez-vous intégrer CHOPS à votre 'stack' d'outils méthodologiques pour vos futures missions ?", libre: "Vous avez la parole : quel est le retour le plus pertinent que vous aimeriez nous donner ?" },
        enseignant: { declic: "En tant qu'enseignant, quel 'déclic' pédagogique avez-vous eu en découvrant le framework CHOPS ?", usage: "Comment avez-vous concrètement utilisé CHOPS ou CHOPi dans un de vos cours ou ateliers ?", clarte: "Du point de vue de l'enseignant, qu'est-ce qui vous semble le plus efficace pour transmettre ce framework aux étudiants ?", equipe: "Comment vos étudiants ont-ils réagi à la méthode ? Qu'est-ce qui a bien fonctionné ou non en classe ?", CHOPi: "Qu'avez-vous pensé de l'outil CHOPi comme support pédagogique ? Que lui manque-t-il ?", reutilisation: "Pensez-vous réutiliser CHOPS dans votre programme de cours à l'avenir ? Si oui, comment ?", libre: "Vous avez la parole : quel est le retour pédagogique le plus important que vous aimeriez nous donner ?" },
        autre: { declic: "Dans votre contexte particulier, quel a été le 'déclic' ou le moment 'aha' où vous avez saisi l'utilité de CHOPS ?", usage: "Comment avez-vous concrètement utilisé CHOPS ou CHOPi dans votre projet ?", clarte: "Qu'est-ce qui a le plus clarifié votre compréhension du framework ?", equipe: "Si vous l'avez utilisé en groupe, comment CHOPS a-t-il structuré vos échanges ou votre travail ?", CHOPi: "Dans votre situation, qu'est-ce qui vous a plu ou manqué dans l'outil CHOPi ?", reutilisation: "Pensez-vous réutiliser CHOPS à l'avenir ? Si oui, dans quel type de projet ou de contexte ?", libre: "Vous avez la parole : quel est le retour le plus important que vous aimeriez nous donner ?" }
      }
    };
  </script>
  <title id="appTitle">Feedback CHOPS</title>
  <meta name="description" content="Mini-Voiceform CHOPS — collecte sécurisée de retours vocaux.">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg-start: #f3f4f6; --bg-end: #e0e7ff; --bg-mid: #dbeafe; --card-bg: rgba(255, 255, 255, 0.45); --card-border: rgba(255, 255, 255, 0.7); --card-shadow: rgba(0, 0, 0, 0.05); --text-primary: #111827; --text-secondary: #4b5563; --accent-primary: #4f46e5; --accent-primary-hover: #4338ca; --accent-success: #16a34a; --accent-record: #dc2626; --accent-pause: #f59e0b; }
    body { background: linear-gradient(-45deg, var(--bg-start), var(--bg-mid), var(--bg-end), var(--bg-mid)); background-size: 400% 400%; animation: gradientBG 25s ease infinite; color: var(--text-primary); padding-bottom: 80px; font-family: Inter, sans-serif; } /* Ajout font Inter */
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .glass-bubble { background-color: var(--card-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--card-border); box-shadow: 0 8px 32px 0 var(--card-shadow); transition: all 0.3s ease; border-radius: 1rem; } /* Ajout border-radius */
    .form-input { background-color: rgba(255, 255, 255, 0.6); border: 1px solid rgba(209, 213, 219, 0.8); color: var(--text-primary); border-radius: 0.5rem; } /* Ajout border-radius */
    .form-input:focus { background-color: rgba(255, 255, 255, 0.9); border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--accent-primary); outline: none; }
    .btn-disabled { opacity: 0.5; cursor: not-allowed; }
    #floatingProgress { background-color: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid var(--card-border); transition: opacity 0.3s, transform 0.3s; z-index: 60; border-top-left-radius: 1rem; border-top-right-radius: 1rem;} /* Ajout border-radius */
    .progress-bar-inner { background: linear-gradient(90deg, var(--accent-primary), var(--accent-success)); background-size: 200% 100%; animation: progress-active 2s ease-in-out infinite; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
    @keyframes progress-active { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
    .hidden { display: none; }
    #profileModal { align-items: flex-start; padding-top: 1rem; padding-bottom: 1rem; }
    @media (min-width: 640px) { #profileModal { align-items: center; } }
    #profileModal .glass-bubble { overflow-y: auto; max-height: 90vh; }
    #profileModal form { overflow-y: visible; padding-bottom: 0; flex-grow: 0; }
    .modal-footer { padding-top: 1rem; text-align: right; }
    .modal-footer.flex { display: flex; align-items: center; justify-content: flex-end; gap: 0.75rem; }
    #toasts { z-index: 70; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    .border-b-2 { border-bottom-width: 2px; }
    .border-indigo-600 { border-color: #4f46e5; }
    .h-5 { height: 1.25rem; } .w-5 { width: 1.25rem; }
    /* Style boutons (classes de base) */
    .btn { padding-left: 1.25rem; padding-right: 1.25rem; padding-top: 0.5rem; padding-bottom: 0.5rem; font-weight: 600; border-radius: 9999px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; outline: 2px solid transparent; outline-offset: 2px; }
    .btn:focus-visible { /* Simule focus:ring-2 focus:ring-offset-2 */ box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-primary); }
    .btn-primary { background-color: var(--accent-primary); color: white; } .btn-primary:hover { background-color: var(--accent-primary-hover); } .btn-primary:focus-visible { box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-primary); }
    .btn-secondary { background-color: white; color: var(--accent-primary); border: 1px solid #e5e7eb; } .btn-secondary:hover { background-color: #f9fafb; } .btn-secondary:focus-visible { box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-primary); }
    .btn-record { background-color: var(--accent-record); color: white; } .btn-record:hover { background-color: #b91c1c; } .btn-record:focus-visible { box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-record); }
    .btn-pause { background-color: var(--accent-pause); color: white; } .btn-pause:hover { background-color: #d97706; } .btn-pause:focus-visible { box-shadow: 0 0 0 2px var(--card-border), 0 0 0 4px var(--accent-pause); }
    .btn-sm { padding-left: 0.75rem; padding-right: 0.75rem; padding-top: 0.25rem; padding-bottom: 0.25rem; font-size: 0.875rem; /* text-sm */}
    .btn-icon { padding: 0.5rem; /* p-2 */ }
  </style>
</head>
<body class="min-h-screen antialiased">

  <header class="max-w-5xl mx-auto px-4 pt-6 pb-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
          <img id="brandLogo" src="https://placehold.co/120x40/f0f0f0/333?text=Logo" alt="Logo" class="h-10 w-auto">
          <h1 id="brandTitle" class="text-xl font-semibold text-gray-800 hidden sm:block"></h1>
      </div>
      <button id="editProfileBtn" class="hidden text-sm font-medium text-indigo-600 hover:text-indigo-800">
          Modifier le profil
      </button>
  </header>

  <main id="mainContent" class="max-w-5xl mx-auto p-4 space-y-6 opacity-0 transition-opacity duration-500">
      <div id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          <!-- Les cartes de questions seront injectées ici par le script -->
      </div>
  </main>

  <div id="floatingProgress" class="fixed bottom-0 left-0 right-0 p-4 shadow-lg">
      <div class="max-w-5xl mx-auto">
          <div class="flex items-center justify-between mb-1">
              <p id="progressText" class="text-sm font-medium text-gray-700" aria-live="polite">0/0 complétées</p>
              <span id="progressPct" class="text-sm font-semibold text-indigo-600">0%</span>
          </div>
          <div class="w-full h-2 rounded-full bg-gray-200 overflow-hidden">
              <div id="progressBar" class="progress-bar-inner h-2 rounded-full" style="width:0%"></div> <!-- Ajout border-radius -->
          </div>
      </div>
  </div>

  <div id="toasts" aria-live="polite" class="fixed top-5 right-5 z-50 w-full max-w-xs space-y-3"></div>

  <!-- MODALE PROFIL -->
   <div id="profileModal" class="fixed inset-0 z-40 flex items-start sm:items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle">
     <div class="fixed inset-0 bg-gray-900/30 backdrop-blur-sm" aria-hidden="true"></div>
     <div class="glass-bubble relative w-full max-w-2xl p-6 sm:p-8 max-h-[90vh] overflow-y-auto">
       <h2 id="profileModalTitle" class="text-2xl font-bold text-gray-900 mb-2">Vos informations</h2>
       <p class="text-sm text-gray-600 mb-6">Pour personnaliser les questions.</p>
       <form id="metaForm" class="space-y-5" novalidate>
         <fieldset class="grid grid-cols-1 sm:grid-cols-2 gap-4"> <div> <label for="studentCode" class="block text-sm font-medium">Identifiant</label> <input id="studentCode" name="studentCode" placeholder="ID_Exemple" class="form-input mt-1 w-full px-3 py-2" required maxlength="32" inputmode="text" pattern="[A-Za-z0-9_\-]+"> <p class="mt-1 text-xs text-gray-500">Ex: ID étudiant, pseudo...</p> </div> <div> <label for="cohort" class="block text-sm font-medium">Contexte</label> <input id="cohort" name="cohort" placeholder="Ex : M2 Info, Projet Y..." class="form-input mt-1 w-full px-3 py-2" required> <p class="mt-1 text-xs text-gray-500">Promo, entreprise, établissement...</p> </div> <div> <label for="profile" class="block text-sm font-medium">Profil</label> <select id="profile" name="profile" class="form-input mt-1 w-full px-3 py-2 appearance-none"> <option value="etudiant" selected>Étudiant</option> <option value="entrepreneur">Entrepreneur</option> <option value="freelance">Freelance</option> <option value="enseignant">Enseignant</option> <option value="autre">Autre</option> </select> </div> <div> <label for="used" class="block text-sm font-medium">Usage de CHOPS</label> <select id="used" name="used" class="form-input mt-1 w-full px-3 py-2 appearance-none"> <option value="CHOPS_only">CHOPS (méthode)</option> <option value="CHOPS_plus_CHOPi">CHOPS + CHOPi (outil IA)</option> <option value="none">Aucun des deux</option> </select> </div> </fieldset>
         <fieldset class="space-y-3 pt-2"> <legend class="text-sm font-medium">Consentement RGPD</legend> <label class="flex items-start gap-3 p-3 rounded-lg bg-white/50 border border-white/80 cursor-pointer"> <input id="consent" type="checkbox" class="mt-1 h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300"> <span class="text-sm text-gray-700">J’accepte le stockage (audio + transcript) et l’usage pédagogique/anonymisé de ces données. Suppression possible sur demande.</span> </label> </fieldset>

         <div class="modal-footer flex">
             <div id="profileSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-600"></div>
             <button id="saveProfileBtn" type="submit" class="btn btn-primary">
               Valider et commencer
             </button>
         </div>
       </form>
     </div>
   </div>

  <!-- MODALE ENREGISTREMENT -->
  <div id="recordModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="fixed inset-0 bg-gray-900/30 backdrop-blur-sm" aria-hidden="true"></div>
    <div class="glass-bubble relative w-full max-w-xl shadow-xl">
      <div class="flex items-start justify-between p-4 border-b border-white/50">
          <div> <p id="modalTheme" class="text-xs uppercase tracking-wide font-semibold text-indigo-700"></p> <h3 id="modalTitle" class="text-lg font-semibold text-gray-900"></h3> </div>
          <button id="modalClose" class="btn btn-secondary btn-icon" aria-label="Fermer"> <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button>
      </div>
      <div class="p-4 sm:p-6 space-y-5">
          <div id="controlsWrap" class="flex flex-col sm:flex-row items-center gap-3">
              <button id="btnRecord" type="button" class="btn btn-record w-full sm:w-auto"> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 8.5a.5.5 0 011 0V10a2 2 0 104 0V8.5a.5.5 0 011 0v1.5a3 3 0 11-6 0V8.5z" /><path d="M9 14a1 1 0 001 1h0a1 1 0 001-1v-1a1 1 0 00-1-1h0a1 1 0 00-1 1v1z" /></svg> Enregistrer </span> </button>
              <button id="btnPause" type="button" class="btn btn-pause w-full sm:w-auto hidden"> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.5 3.5A1.5 1.5 0 017 5v10a1.5 1.5 0 01-3 0V5a1.5 1.5 0 011.5-1.5zM12.5 3.5A1.5 1.5 0 0114 5v10a1.5 1.5 0 01-3 0V5a1.5 1.5 0 011.5-1.5z" clip-rule="evenodd" /></svg> Pause </span> </button>
              <button id="btnResume" type="button" class="btn btn-record w-full sm:w-auto hidden"> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 8.5a.5.5 0 011 0V10a2 2 0 104 0V8.5a.5.5 0 011 0v1.5a3 3 0 11-6 0V8.5z" /><path d="M9 14a1 1 0 001 1h0a1 1 0 001-1v-1a1 1 0 00-1-1h0a1 1 0 00-1 1v1z" /></svg> Reprendre </span> </button>
              <button id="btnStop" type="button" class="btn btn-secondary w-full sm:w-auto hidden" disabled> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 3.5A1.5 1.5 0 016.5 2h7A1.5 1.5 0 0115 3.5v7a1.5 1.5 0 01-1.5 1.5h-7A1.5 1.5 0 015 10.5v-7z" clip-rule="evenodd" /></svg> Stop </span> </button>
              <div class="flex-1 w-full pt-2 sm:pt-0"> <div class="h-2 rounded-full bg-white/60 overflow-hidden"><div id="meter" class="h-2 bg-green-500 transition-all duration-75 rounded-full" style="width:0%"></div></div> <p class="mt-1 text-xs text-gray-600 text-right"><span id="timer">00:00</span> / ${hhmmss(CONFIG.LIMITS.MAX_SECONDS)}</p> </div>
          </div>
          <div id="previewWrap" class="hidden space-y-4">
              <button id="btnReRecord" type="button" class="btn btn-secondary btn-sm"> ↺ Réenregistrer </button>
              <audio id="player" controls controlsList="nodownload noplaybackrate" class="w-full rounded-full"></audio> <!-- Ajout border-radius + controlsList -->
              <p id="fileInfo" class="mt-1 text-xs text-gray-500"></p>
          </div>
      </div>
      <div class="p-4 border-t border-white/50 flex items-center justify-between">
          <p class="text-xs text-gray-500">État : <span id="status">Prêt</span></p>
          <button id="btnSend" class="btn btn-primary btn-disabled" disabled> Envoyer cette réponse </button>
      </div>
    </div>
  </div>

  <script>
    // ... CONFIG, $, toast, localStorage inchangés ...
    const CONFIG = window.APP_CONFIG || {}; const $ = (selector) => document.querySelector(selector); function toast(msg, type = 'info') { /* ... */ } const LS_KEYS = { META: '...', STATUS_PREFIX: '...' }; function saveMeta(meta) { /* ... */ } function loadMeta() { /* ... */ } function saveStatus(studentId, status) { /* ... */ } function loadStatus(studentId) { /* ... */ }

    document.addEventListener('DOMContentLoaded', () => {
      // ... Sélecteurs principaux (ajout profileSpinner) ...
      const profileModal = $('#profileModal'); const metaForm = $('#metaForm'); const saveProfileBtn = $('#saveProfileBtn'); const editProfileBtn = $('#editProfileBtn'); const mainContent = $('#mainContent'); const cardsGrid = $('#cardsGrid'); const recordModal = $('#recordModal'); const modalClose = $('#modalClose'); const statusEl = $('#status'); const floatingProgress = $('#floatingProgress'); const progressText = $('#progressText'); const progressPct = $('#progressPct'); const progressBar = $('#progressBar'); const profileSpinner = $('#profileSpinner');
      if (!profileModal || !metaForm || !saveProfileBtn || !mainContent || !profileSpinner) { toast("Erreur UI.", "err"); return; }

      // ... État de l'application inchangé ...
      let currentMeta = {/* ... */}; let currentStatus = {}; let topics = []; let currentTopic = null; let lastTrigger = null; let sending = false; let currentAnimatedPct = 0; let isSubmittingProfile = false;

      // ... Branding, visibilitychange, initProfile inchangés ...
      try { /* ... branding ... */ } catch (e) { /* ... */ }
      document.addEventListener("visibilitychange", () => { /* ... */ });
      function initProfile() { /* ... */ }

      // --- Gestionnaire soumission formulaire profil (AVEC ensureUserFolder) ---
      metaForm.addEventListener('submit', async (e) => {
        e.preventDefault(); if (isSubmittingProfile) return;
        isSubmittingProfile = true; saveProfileBtn.disabled = true; saveProfileBtn.classList.add('btn-disabled'); profileSpinner.classList.remove('hidden');
        const studentCode = $('#studentCode').value.trim(); const cohort = $('#cohort').value.trim(); const consent = $('#consent').checked; const profile = $('#profile').value; const used = $('#used').value;
        if (!/^[A-Za-z0-9_\-]{1,32}$/.test(studentCode)) { toast('ID invalide.', 'warn'); isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); profileSpinner.classList.add('hidden'); return; }
        if (cohort.length < 1) { toast('Contexte requis.', 'warn'); isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); profileSpinner.classList.add('hidden'); return; }
        if (!consent) { toast('Consentement requis.', 'warn'); isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); profileSpinner.classList.add('hidden'); return; }
        currentMeta = { studentCode, cohort, profile, used, consent: true }; saveMeta(currentMeta); currentStatus = loadStatus(currentMeta.studentCode);
        try {
          console.log('[FORM SUBMIT] Appel ensureUserFolder...'); const folderPayload = { action: "ensureUserFolder", studentCode: currentMeta.studentCode, cohort: currentMeta.cohort, profile: currentMeta.profile, used: currentMeta.used };
          const folderJson = await fetchGAS(CONFIG.WEBAPP_URL, folderPayload);
          if (folderJson.ok === false) { throw new Error(folderJson.error || 'Erreur création dossier.'); }
          console.log('[FORM SUBMIT] Dossier Drive OK.');
          profileModal.classList.add('hidden'); renderAllCards(); mainContent.classList.remove('opacity-0'); editProfileBtn.classList.remove('hidden'); toast('Profil enregistré !', 'ok');
        } catch (folderErr) { console.error('[FORM SUBMIT] Erreur ensureUserFolder:', folderErr); toast(`Erreur config Drive : ${folderErr.message}.`, 'err');
        } finally { isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); profileSpinner.classList.add('hidden'); }
      });

      // ... Bouton editProfile inchangé ...
      if (editProfileBtn) { editProfileBtn.addEventListener('click', () => { /*...*/ }); }

      // ... Rendu cartes, progression, modale enregistrement, logique enregistrement (start/stop etc) INCHANGÉS ...
      function getQuestion(profile, topic) { /* ... */ } function renderAllCards() { /* ... */ } function updateProgress() { /* ... */ } function animateCounter(el, from, to, suffix = '') { /* ... */ }
      const btnRecord = $('#btnRecord'); /* ... */ let mediaStream, mediaRecorder, audioBlob = null, mimeType = 'audio/webm'; /* ... */
      function openModal(topic, trigger) { /* ... */ } function closeModal() { /* ... */ } /* ... listeners ... */ function setStatus(t) { /* ... */ } function hhmmss(s) { const sec = Math.max(0, Math.floor(s)); return `${String(Math.floor(sec / 60)).padStart(2, '0')}:${String(sec % 60).padStart(2, '0')}`; } function updateSendState() { /* ... */ }
      function resetRecording(inModal = false) { /* ... */ }
      if(btnRecord) btnRecord.addEventListener('click', startRecording); /* ... listeners ... */
      async function startRecording() { /* ... */ } function pauseRecording() { /* ... */ } function resumeRecording() { /* ... */ } function stopRecording() { /* ... */ }

      // --- fetchGAS ET blobToBase64 --- (Inchangés)
      async function fetchGAS(url, payload) { if (!url || !url.startsWith("https://script.google.com")) throw new Error("Backend URL invalide."); try { const response = await fetch(url, { method: 'POST', mode: 'cors', credentials: 'omit', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload), redirect: 'follow' }); if (!response.ok) { let errorText = `Erreur réseau: ${response.statusText} (${response.status})`; try { const errJson = await response.json(); if (errJson?.error) errorText = `Erreur backend: ${errJson.error}`; } catch(e) {} throw new Error(errorText); } return response.json(); } catch (err) { console.error("Erreur fetchGAS:", err); throw new Error("Communication serveur échouée."); } }
      function blobToBase64(blob) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => { try { const base64 = reader.result.split(',')[1]; if (!base64) throw new Error("Conv Base64 invalide."); resolve(base64); } catch (err) { reject(err); } }; reader.onerror = reject; reader.readAsDataURL(blob); }); }

      // --- submitOne --- (Utilise l'UX "envoyer et considérer OK si HTTP 200")
      if(btnSend) btnSend.addEventListener('click', submitOne);
      async function submitOne() {
         if (sending || !audioBlob) return;
         sending = true;
         setStatus('Préparation envoi...');
         if (modalClose) modalClose.disabled = true; if (btnReRecord) btnReRecord.disabled = true; btnReRecord.classList.add('btn-disabled');
         updateSendState(); toast('Envoi de votre réponse...');
         try {
           const fileBase64 = await blobToBase64(audioBlob); const [mm, ss] = timerEl ? timerEl.textContent.split(':').map(Number) : [0, 0]; const durationSec = (mm * 60 + ss) || 0;
           const payload = { action: "uploadAudio", ...currentMeta, topic: currentTopic, durationSec: durationSec, mimeType: mimeType, transcription: "[CLIENT_TRANSCRIPTION_DISABLED]", fileBase64: fileBase64, clientUA: navigator.userAgent };
           console.log("----------------------------------------"); console.log("Frontend: Envoi du payload à", CONFIG.WEBAPP_URL); console.log("MimeType envoyé:", payload.mimeType);
           setStatus('Envoi en cours...');
           const response = await fetch(CONFIG.WEBAPP_URL, { method: 'POST', mode: 'cors', credentials: 'omit', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload), redirect: 'follow' });
           if (!response.ok) { let errorText = `Erreur réseau ${response.status}: ${response.statusText}`; try { const bodyText = await response.text(); console.error("Réponse d'erreur brute du backend:", bodyText); const errJson = JSON.parse(bodyText); if (errJson && errJson.error) { errorText = errJson.error; } else if (bodyText) { errorText = bodyText.slice(0, 100); } } catch(e) { console.warn("Impossible lire/parser erreur"); } throw new Error(errorText); }
           console.log("Frontend: Communication backend OK (HTTP 200).");
           setStatus('Terminé ✅'); toast('Réponse envoyée !', 'ok');
           currentStatus[currentTopic] = { done: true, at: new Date().toISOString(), durationSec: durationSec }; saveStatus(currentMeta.studentCode, currentStatus);
           renderAllCards();
           // closeModal(); // Déplacé dans finally
         } catch (err) {
           console.error('Erreur finale submitOne:', err); toast(`Erreur d’envoi : ${err.message}. Réessayez.`, 'err'); setStatus('Erreur d’envoi');
         } finally {
           sending = false; if (modalClose) modalClose.disabled = false; if (btnReRecord) btnReRecord.disabled = false; btnReRecord.classList.remove('btn-disabled');
           updateSendState(); console.log("------------------- submitOne terminé --------------------");
           closeModal(); // Ferme TOUJOURS la modale
         }
      } // Fin submitOne

      // --- Démarrage ---
      initProfile();
      console.log("Initialisation terminée.");

    }); // Fin DOMContentLoaded
  </script>
</body>
</html>
