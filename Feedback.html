<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link id="favicon" rel="icon" href="./assets/favicon.png">

  <!-- =================================================================================== -->
  <!-- =========================== CONFIGURATION DE L'APPLICATION ====================== -->
  <!-- =================================================================================== -->
  <script id="app-config">
    /*
     * Configurez votre application ici.
     */
    window.APP_CONFIG = {
      // --- Backend URL ---
      // CORRECTION: Assurez-vous que c'est la bonne URL de votre Script A (Receiver)
      WEBAPP_URL: "https://script.google.com/macros/s/AKfycbxRz2Od1d82fQfik128ijnuCJ4LWkRWDMW8lKZqqt9HX52NINWXoU-LcfuJo7tzENY/exec",

      // --- Branding ---
      BRAND: {
        TITLE: "Feedback CHOPS v21", // Gardé votre titre
        LOGO_URL: "./CHOPStandard.svg",
        MARK_URL: "./CHOPiBasic.svg",
        FAVICON_URL: "./CHOPiBasic.svg"
      },

      // --- Limites d'enregistrement ---
      LIMITS: {
        MAX_SECONDS: 120, // 2 minutes
        MAX_BYTES: 10 * 1024 * 1024, // 10MB
      },

      // --- Questions (Inchangé) ---
      QUESTIONS: {
        etudiant: { declic: "En tant qu'étudiant, quel a été le 'déclic' ou le moment 'aha' où vous avez saisi l'utilité de CHOPS ?", usage: "Comment avez-vous concrètement utilisé CHOPS ou CHOPi pour un projet académique ou personnel ?", clarte: "Qu'est-ce qui a le plus clarifié votre compréhension du framework ? (ex: un cours, un exemple, CHOPi...)", equipe: "Si vous l'avez utilisé en groupe, comment CHOPS a-t-il structuré vos échanges ou votre travail d'équipe ?", CHOPi: "Dans votre parcours d'apprentissage, qu'est-ce qui vous a plu ou manqué dans l'outil CHOPi ?", reutilisation: "Pensez-vous réutiliser CHOPS à l'avenir ? Si oui, dans quel type de projet ou de contexte ?", libre: "Vous avez la parole : quel est le retour le plus important que vous aimeriez nous donner ?" },
        entrepreneur: { declic: "En tant qu'entrepreneur, quel problème concret pensiez-vous résoudre ou quel 'déclic' avez-vous eu avec CHOPS ?", usage: "Comment avez-vous appliqué CHOPS ou CHOPi sur un de vos projets ou 'use case' d'entreprise ?", clarte: "Qu'est-ce qui, dans le framework, a le plus aidé à clarifier votre vision stratégique ou celle de vos équipes ?", equipe: "Comment vos équipes (ou vous-même) ont-elles interagi avec la méthode ? Quels ont été les points de friction ou de fluidité ?", CHOPi: "En tant que décideur, qu'avez-vous pensé de l'outil CHOPi ? Qu'est-ce qui lui manque pour être un outil pro ?", reutilisation: "Voyez-vous un potentiel de réutilisation de CHOPS pour d'autres 'use cases' dans votre organisation ?", libre: "Vous avez la parole : quel est le retour leF plus stratégique que vous aimeriez nous donner ?" },
        freelance: { declic: "En tant que freelance, quel a été le 'déclic' où vous vous êtes dit 'tiens, CHOPS pourrait m'aider avec mes clients' ?", usage: "Avez-vous pu utiliser CHOPS ou CHOPi (même mentalement) pour cadrer la mission d'un client ou un projet personnel ?", clarte: "Quelle partie du framework vous semble la plus utile pour structurer et vendre vos prestations de conseil ou de production ?", equipe: "En travaillant (souvent seul ou en petite équipe), comment CHOPS vous aide-t-il à mieux dialoguer avec vos clients/partenaires ?", CHOPi: "En tant qu'indépendant, que vous a-t-il plu ou manqué dans l'outil CHOPi pour vos propres besoins ?", reutilisation: "Pensez-vous intégrer CHOPS à votre 'stack' d'outils méthodologiques pour vos futures missions ?", libre: "Vous avez la parole : quel est le retour le plus pertinent que vous aimeriez nous donner ?" },
        enseignant: { declic: "En tant qu'enseignant, quel 'déclic' pédagogique avez-vous eu en découvrant le framework CHOPS ?", usage: "Comment avez-vous concrètement utilisé CHOPS ou CHOPi dans un de vos cours ou ateliers ?", clarte: "Du point de vue de l'enseignant, qu'est-ce qui vous semble le plus efficace pour transmettre ce framework aux étudiants ?", equipe: "Comment vos étudiants ont-ils réagi à la méthode ? Qu'est-ce qui a bien fonctionné ou non en classe ?", CHOPi: "Qu'avez-vous pensé de l'outil CHOPi comme support pédagogique ? Que lui manque-t-il ?", reutilisation: "Pensez-vous réutiliser CHOPS dans votre programme de cours à l'avenir ? Si oui, comment ?", libre: "Vous avez la parole : quel est le retour pédagogique le plus important que vous aimeriez nous donner ?" },
        autre: { declic: "Dans votre contexte particulier, quel a été le 'déclic' ou le moment 'aha' où vous avez saisi l'utilité de CHOPS ?", usage: "Comment avez-vous concrètement utilisé CHOPS ou CHOPi dans votre projet ?", clarte: "Qu'est-ce qui a le plus clarifié votre compréhension du framework ?", equipe: "Si vous l'avez utilisé en groupe, comment CHOPS a-t-il structuré vos échanges ou votre travail ?", CHOPi: "Dans votre situation, qu'est-ce qui vous a plu ou manqué dans l'outil CHOPi ?", reutilisation: "Pensez-vous réutiliser CHOPS à l'avenir ? Si oui, dans quel type de projet ou de contexte ?", libre: "Vous avez la parole : quel est le retour le plus important que vous aimeriez nous donner ?" }
      }
    };
  </script>
  <!-- =================================================================================== -->
  <!-- ============================= FIN DE LA CONFIGURATION =========================== -->
  <!-- =================================================================================== -->

  <title id="appTitle">Feedback CHOPS</title>
  <meta name="description" content="Mini-Voiceform CHOPS — collecte sécurisée de retours vocaux.">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ... Styles CSS inchangés ... */
    :root { --bg-start: #f3f4f6; --bg-end: #e0e7ff; --bg-mid: #dbeafe; --card-bg: rgba(255, 255, 255, 0.45); --card-border: rgba(255, 255, 255, 0.7); --card-shadow: rgba(0, 0, 0, 0.05); --text-primary: #111827; --text-secondary: #4b5563; --accent-primary: #4f46e5; --accent-primary-hover: #4338ca; --accent-success: #16a34a; --accent-record: #dc2626; --accent-pause: #f59e0b; }
    body { background: linear-gradient(-45deg, var(--bg-start), var(--bg-mid), var(--bg-end), var(--bg-mid)); background-size: 400% 400%; animation: gradientBG 25s ease infinite; color: var(--text-primary); padding-bottom: 80px; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .glass-bubble { background-color: var(--card-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--card-border); box-shadow: 0 8px 32px 0 var(--card-shadow); transition: all 0.3s ease; }
    .form-input { background-color: rgba(255, 255, 255, 0.6); border: 1px solid rgba(209, 213, 219, 0.8); color: var(--text-primary); }
    .form-input:focus { background-color: rgba(255, 255, 255, 0.9); border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--accent-primary); outline: none; }
    .btn-disabled { opacity: 0.5; cursor: not-allowed; }
    #floatingProgress { background-color: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid var(--card-border); transition: opacity 0.3s, transform 0.3s; z-index: 60; }
    .progress-bar-inner { background: linear-gradient(90deg, var(--accent-primary), var(--accent-success)); background-size: 200% 100%; animation: progress-active 2s ease-in-out infinite; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
    @keyframes progress-active { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
    .hidden { display: none; }
    #profileModal { align-items: flex-start; padding-top: 1rem; padding-bottom: 1rem; }
    @media (min-width: 640px) { #profileModal { align-items: center; } }
    #profileModal .glass-bubble { overflow-y: auto; max-height: 90vh; }
    #profileModal form { overflow-y: visible; padding-bottom: 0; flex-grow: 0; }
    .modal-footer { padding-top: 1rem; text-align: right; }
    #toasts { z-index: 70; }
  </style>
</head>
<body class="min-h-screen font-sans antialiased">

  <!-- ... Header, Main Content, Barre de progression, Toasts inchangés ... -->
  <header class="max-w-5xl mx-auto px-4 pt-6 pb-3 flex items-center justify-between gap-3"> <div class="flex items-center gap-3"> <img id="brandLogo" src="https://placehold.co/120x40/f0f0f0/333?text=Logo" alt="Logo" class="h-10 w-auto"> <h1 id="brandTitle" class="text-xl font-semibold text-gray-800 hidden sm:block"></h1> </div> <button id="editProfileBtn" class="hidden text-sm font-medium text-indigo-600 hover:text-indigo-800"> Modifier le profil </button> </header>
  <main id="mainContent" class="max-w-5xl mx-auto p-4 space-y-6 opacity-0 transition-opacity duration-500"> <div id="cardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"> <!-- Les cartes --> </div> </main>
  <div id="floatingProgress" class="fixed bottom-0 left-0 right-0 p-4 shadow-lg"> <div class="max-w-5xl mx-auto"> <div class="flex items-center justify-between mb-1"> <p id="progressText" class="text-sm font-medium text-gray-700" aria-live="polite">0/0 complétées</p> <span id="progressPct" class="text-sm font-semibold text-indigo-600">0%</span> </div> <div class="w-full h-2 rounded-full bg-gray-200 overflow-hidden"> <div id="progressBar" class="progress-bar-inner h-2" style="width:0%"></div> </div> </div> </div>
  <div id="toasts" aria-live="polite" class="fixed top-5 right-5 w-full max-w-xs space-y-3"></div>

  <!-- ... Modale de Profil inchangée ... -->
   <div id="profileModal" class="fixed inset-0 z-40 flex items-start sm:items-center justify-center p-4 pt-4 pb-4" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle"> <div class="fixed inset-0 bg-gray-900/30 backdrop-blur-sm" aria-hidden="true"></div> <div class="glass-bubble relative w-full max-w-2xl rounded-2xl p-6 sm:p-8 max-h-[90vh] overflow-y-auto"> <h2 id="profileModalTitle" class="text-2xl font-bold text-gray-900 mb-2">Vos informations</h2> <p class="text-sm text-gray-600 mb-6">Pour personnaliser les questions, veuillez renseigner les champs ci-dessous.</p> <form id="metaForm" class="space-y-5" novalidate> <fieldset class="grid grid-cols-1 sm:grid-cols-2 gap-4"> <div> <label for="studentCode" class="block text-sm font-medium">Identifiant</label> <input id="studentCode" name="studentCode" placeholder="ID_Exemple" class="form-input mt-1 w-full rounded-lg px-3 py-2" required maxlength="32" inputmode="text" pattern="[A-Za-z0-9_\-]+"> <p class="mt-1 text-xs text-gray-500">Un pseudo ou identifiant (ex: ID étudiant).</p> </div> <div> <label for="cohort" class="block text-sm font-medium">Contexte</label> <input id="cohort" name="cohort" placeholder="Ex : 3A, Startup X, Lycée Y…" class="form-input mt-1 w-full rounded-lg px-3 py-2" required> <p class="mt-1 text-xs text-gray-500">Votre promo, entreprise, établissement...</p> </div> <div> <label for="profile" class="block text-sm font-medium">Profil</label> <select id="profile" name="profile" class="form-input mt-1 w-full rounded-lg px-3 py-2"> <option value="etudiant" selected>Étudiant</option> <option value="entrepreneur">Entrepreneur</option> <option value="freelance">Freelance</option> <option value="enseignant">Enseignant</option> <option value="autre">Autre</option> </select> </div> <div> <label for="used" class="block text-sm font-medium">Usage de CHOPS</label> <select id="used" name="used" class="form-input mt-1 w-full rounded-lg px-3 py-2"> <option value="CHOPS_only">CHOPS (méthode)</option> <option value="CHOPS_plus_CHOPi">CHOPS + CHOPi (outil IA)</option> <option value="none">Aucun des deux</option> </select> </div> </fieldset> <fieldset class="space-y-3 pt-2"> <legend class="text-sm font-medium">Consentement RGPD</legend> <label class="flex items-start gap-3 p-3 rounded-lg bg-white/50 border border-white/80"> <input id="consent" type="checkbox" class="mt-1 h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"> <span class="text-sm text-gray-700">J’accepte le stockage privé sur Google Drive (audio + transcription) et l’usage pédagogique/anonymisé de ces données. Vous pouvez demander la suppression à tout moment.</span> </label> </fieldset> <div class="modal-footer"> <button id="saveProfileBtn" type="submit" class="px-5 py-2 font-semibold rounded-full shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500"> Valider et commencer </button> </div> </form> </div> </div>

  <!-- ... Modale d'enregistrement inchangée ... -->
  <div id="recordModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle"> <div class="fixed inset-0 bg-gray-900/30 backdrop-blur-sm" aria-hidden="true"></div> <div class="glass-bubble relative w-full max-w-xl rounded-2xl shadow-xl"> <div class="flex items-start justify-between p-4 border-b border-white/50"> <div> <p id="modalTheme" class="text-xs uppercase tracking-wide font-semibold text-indigo-700"></p> <h3 id="modalTitle" class="text-lg font-semibold text-gray-900"></h3> </div> <button id="modalClose" class="p-2 font-semibold rounded-full shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50 focus:ring-indigo-500 !shadow-none" aria-label="Fermer"> <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div class="p-4 sm:p-6 space-y-5"> <div id="controlsWrap" class="flex flex-col sm:flex-row items-center gap-3"> <button id="btnRecord" type="button" class="px-5 py-2 font-semibold rounded-full shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 w-full sm:w-auto"> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 8.5a.5.5 0 011 0V10a2 2 0 104 0V8.5a.5.5 0 011 0v1.5a3 3 0 11-6 0V8.5z" /><path d="M9 14a1 1 0 001 1h0a1 1 0 001-1v-1a1 1 0 00-1-1h0a1 1 0 00-1 1v1z" /></svg> Enregistrer </span> </button> <button id="btnPause" type="button" class="px-5 py-2 font-semibold rounded-full shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-amber-500 text-white hover:bg-amber-600 focus:ring-amber-500 w-full sm:w-auto hidden"> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.5 3.5A1.5 1.5 0 017 5v10a1.5 1.5 0 01-3 0V5a1.5 1.5 0 011.5-1.5zM12.5 3.5A1.5 1.5 0 0114 5v10a1.5 1.5 0 01-3 0V5a1.5 1.5 0 011.5-1.5z" clip-rule="evenodd" /></svg> Pause </span> </button> <button id="btnResume" type="button" class="px-5 py-2 font-semibold rounded-full shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 w-full sm:w-auto hidden"> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 8.5a.5.5 0 011 0V10a2 2 0 104 0V8.5a.5.5 0 011 0v1.5a3 3 0 11-6 0V8.5z" /><path d="M9 14a1 1 0 001 1h0a1 1 0 001-1v-1a1 1 0 00-1-1h0a1 1 0 00-1 1v1z" /></svg> Reprendre </span> </button> <button id="btnStop" type="button" class="px-5 py-2 font-semibold rounded-full shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50 focus:ring-indigo-500 w-full sm:w-auto hidden" disabled> <span class="flex items-center justify-center gap-2"> <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 3.5A1.5 1.5 0 016.5 2h7A1.5 1.5 0 0115 3.5v7a1.5 1.5 0 01-1.5 1.5h-7A1.5 1.5 0 015 10.5v-7z" clip-rule="evenodd" /></svg> Stop </span> </button> <div class="flex-1 w-full pt-2 sm:pt-0"> <div class="h-2 rounded-full bg-white/60 overflow-hidden"><div id="meter" class="h-2 bg-green-500 transition-all duration-75" style="width:0%"></div></div> <p class="mt-1 text-xs text-gray-600 text-right"><span id="timer">00:00</span> / 02:00</p> </div> </div> <div id="previewWrap" class="hidden space-y-4"> <button id="btnReRecord" type="button" class="px-5 py-2 font-semibold rounded-full shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50 focus:ring-indigo-500 text-sm"> ↺ Réenregistrer </button> <audio id="player" controls class="w-full"></audio> <div id="transcriptionWrap" class="p-3 rounded-lg bg-white/60 border border-white/80 hidden"> <p class="text-xs font-medium text-gray-500 mb-1">Transcription (auto)</p> <p id="transcriptionText" class="text-sm text-gray-700 italic">La transcription sera générée par le serveur après l'envoi.</p> </div> <p id="fileInfo" class="mt-1 text-xs text-gray-500"></p> </div> </div> <div class="p-4 border-t border-white/50 flex items-center justify-between"> <p class="text-xs text-gray-500">État : <span id="status">Prêt</span></p> <button id="btnSend" class="px-5 py-2 font-semibold rounded-full shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500 btn-disabled" disabled> Envoyer cette réponse </button> </div> </div> </div>

  <script>
    // ... Configuration globale, fonctions $, toast, localStorage inchangées ...
    const CONFIG = window.APP_CONFIG || {};
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    function toast(msg, type = 'info') { const w = $('#toasts'); if (!w) return; const d = document.createElement('div'); let c = 'bg-gray-700'; if (type === 'ok') c = 'bg-green-600'; if (type === 'warn') c = 'bg-amber-500'; if (type === 'err') c = 'bg-red-600'; d.className = `${c} text-white rounded-xl px-4 py-3 mb-2 shadow-lg text-sm font-medium transition-all duration-300 transform translate-x-full opacity-0`; d.textContent = msg; w.appendChild(d); requestAnimationFrame(() => { requestAnimationFrame(() => { d.classList.remove('translate-x-full', 'opacity-0'); d.classList.add('translate-x-0', 'opacity-100'); }); }); setTimeout(() => { d.classList.add('translate-x-full', 'opacity-0'); d.addEventListener('transitionend', () => d.remove(), { once: true }); }, 3500); }
    const LS_KEYS = { META: 'chops_voiceform_meta', STATUS_PREFIX: 'chops_voiceform_status_' };
    function saveMeta(meta) { try { localStorage.setItem(LS_KEYS.META, JSON.stringify(meta)); } catch (e) { console.error("LS save meta:", e); toast("Err profil.", "err"); } }
    function loadMeta() { try { return JSON.parse(localStorage.getItem(LS_KEYS.META) || '{}'); } catch (e) { console.error("LS load meta:", e); return {}; } }
    function saveStatus(studentId, status) { if (!studentId) return; try { localStorage.setItem(LS_KEYS.STATUS_PREFIX + studentId, JSON.stringify(status)); } catch (e) { console.error("LS save status:", e); toast("Err progr.", "err"); } }
    function loadStatus(studentId) { if (!studentId) return {}; try { return JSON.parse(localStorage.getItem(LS_KEYS.STATUS_PREFIX + studentId) || '{}'); } catch (e) { console.error("LS load status:", e); return {}; } }

    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM Chargé, initialisation...");

      // ... Sélecteurs principaux inchangés ...
      const profileModal = $('#profileModal'); const metaForm = $('#metaForm'); const saveProfileBtn = $('#saveProfileBtn'); const editProfileBtn = $('#editProfileBtn'); const mainContent = $('#mainContent'); const cardsGrid = $('#cardsGrid'); const recordModal = $('#recordModal'); const modalClose = $('#modalClose'); const statusEl = $('#status'); const floatingProgress = $('#floatingProgress'); const progressText = $('#progressText'); const progressPct = $('#progressPct'); const progressBar = $('#progressBar');
      if (!profileModal || !metaForm || !saveProfileBtn || !mainContent) { console.error("Éléments UI manquants !"); toast("Erreur UI.", "err"); return; }

      // ... État de l'application inchangé ...
      let currentMeta = { studentCode: '', cohort: '', profile: 'etudiant', used: 'CHOPS_plus_CHOPi', consent: false }; let currentStatus = {}; let topics = []; let currentTopic = null; let lastTrigger = null; let sending = false; let currentAnimatedPct = 0; let isSubmittingProfile = false;

      // ... Branding inchangé ...
      try { const brandTitleText = CONFIG.BRAND.TITLE || "Feedback App"; document.title = brandTitleText; if ($('#brandTitle')) $('#brandTitle').textContent = brandTitleText; if ($('#brandLogo')) $('#brandLogo').src = CONFIG.BRAND.LOGO_URL; if ($('#favicon')) $('#favicon').href = CONFIG.BRAND.FAVICON_URL; } catch (e) { console.error("Erreur Branding:", e); toast("Err branding.", "warn"); }

      // ... Initialisation du profil inchangée ...
      document.addEventListener("visibilitychange", () => { if (!audioContext || audioContext.state === 'closed') return; if (document.visibilityState === 'visible') { console.log("Tab visible, resume AudioContext"); audioContext.resume().catch(e => console.warn("Err resume AC", e)); } });
      function initProfile() { const meta = loadMeta(); if (meta && meta.studentCode && meta.cohort && meta.profile && meta.used && meta.consent === true) { currentMeta = meta; $('#studentCode').value = meta.studentCode; $('#cohort').value = meta.cohort; $('#profile').value = meta.profile; $('#used').value = meta.used; $('#consent').checked = meta.consent; profileModal.classList.add('hidden'); mainContent.classList.remove('opacity-0'); editProfileBtn.classList.remove('hidden'); currentStatus = loadStatus(currentMeta.studentCode); renderAllCards(); console.log("Profil OK."); } else { console.log("Profil invalide."); profileModal.classList.remove('hidden'); mainContent.classList.add('opacity-0'); editProfileBtn.classList.add('hidden'); updateProgress(); } }
      metaForm.addEventListener('submit', (e) => { e.preventDefault(); if (isSubmittingProfile) return; isSubmittingProfile = true; saveProfileBtn.disabled = true; saveProfileBtn.classList.add('btn-disabled'); const studentCode = $('#studentCode').value.trim(); const cohort = $('#cohort').value.trim(); const consent = $('#consent').checked; if (!/^[A-Za-z0-9_\-]{1,32}$/.test(studentCode)) { toast('ID invalide.', 'warn'); isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); return; } if (cohort.length < 1) { toast('Contexte requis.', 'warn'); isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); return; } if (!consent) { toast('Consentement requis.', 'warn'); isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); return; } currentMeta = { studentCode: studentCode, cohort: cohort, profile: $('#profile').value, used: $('#used').value, consent: true }; saveMeta(currentMeta); currentStatus = loadStatus(currentMeta.studentCode); profileModal.classList.add('hidden'); renderAllCards(); mainContent.classList.remove('opacity-0'); editProfileBtn.classList.remove('hidden'); toast('Profil enregistré !', 'ok'); isSubmittingProfile = false; saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('btn-disabled'); });
      if (editProfileBtn) { editProfileBtn.addEventListener('click', () => { $('#studentCode').value = currentMeta.studentCode; $('#cohort').value = currentMeta.cohort; $('#profile').value = currentMeta.profile; $('#used').value = currentMeta.used; $('#consent').checked = currentMeta.consent; profileModal.classList.remove('hidden'); }); }

      // ... Rendu des cartes et progression inchangé ...
      function getQuestion(profile, topic) { try { let p = profile || 'autre'; let q = CONFIG.QUESTIONS[p]; if (!q || !q.hasOwnProperty(topic)) { p = 'autre'; q = CONFIG.QUESTIONS['autre']; } if (!q || !q.hasOwnProperty(topic)) { return "[Question manquante]"; } return q[topic]; } catch (e) { return "[Erreur question]"; } }
      function renderAllCards() { let p = currentMeta.profile || 'autre'; let q = CONFIG.QUESTIONS[p]; if (!q || typeof q !== 'object') { p = 'autre'; q = CONFIG.QUESTIONS['autre']; } if (!q || typeof q !== 'object') { topics = []; if (cardsGrid) cardsGrid.innerHTML = '<p>Err config.</p>'; updateProgress(); return; } topics = Object.keys(q); if (topics.length === 0) { if (cardsGrid) cardsGrid.innerHTML = '<p>Aucune question.</p>'; } else { if (cardsGrid) cardsGrid.innerHTML = ''; topics.forEach(t => { const entry = currentStatus[t]; const done = !!entry?.done; const qt = getQuestion(p, t); const card = document.createElement('button'); card.type = 'button'; card.dataset.topic = t; card.className = `glass-bubble w-full text-left rounded-xl p-5 space-y-3 transition duration-200 hover:shadow-lg hover:-translate-y-1 ${done ? 'opacity-70 hover:opacity-100' : ''}`; card.innerHTML = `<div class="flex items-center justify-between"><span class="flex items-center gap-2 text-sm font-semibold text-indigo-700"><img src="${CONFIG.BRAND.MARK_URL}" alt="" class="h-5 w-5"> ${t.charAt(0).toUpperCase() + t.slice(1)} </span> ${done ? `<span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-medium">Répondu</span>` : `<span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 text-xs font-medium">À faire</span>`} </div> <p class="text-sm text-gray-800">${qt}</p> ${done && entry.at ? `<p class="text-xs text-gray-500 pt-2">Répondu le ${new Date(entry.at).toLocaleDateString()}</p>` : ''}`; card.addEventListener('click', () => openModal(t, card)); if (cardsGrid) cardsGrid.appendChild(card); }); } updateProgress(); }
      function updateProgress() { const vt = Array.isArray(topics) ? topics : []; const done = vt.filter(t => !!currentStatus[t]?.done).length; const total = vt.length; const pct = (total > 0) ? Math.round((done / total) * 100) : 0; if (progressText) progressText.textContent = `${done}/${total} complétées`; animateCounter(progressPct, currentAnimatedPct, pct, '%'); currentAnimatedPct = pct; if (progressBar) progressBar.style.width = `${pct}%`; }
      function animateCounter(el, from, to, suffix = '') { if (!el) return; if (from === to) { el.textContent = `${to}${suffix}`; return; } const duration = 400; const frameRate = 1000 / 60; const totalFrames = Math.round(duration / frameRate); const diff = to - from; let frame = 0; let animationFrameId; function step() { frame++; const progress = 1 - Math.pow(1 - (frame / totalFrames), 2); const currentVal = from + (diff * progress); el.textContent = `${Math.round(currentVal)}${suffix}`; if (frame < totalFrames) { animationFrameId = requestAnimationFrame(step); } else { el.textContent = `${to}${suffix}`; } } cancelAnimationFrame(animationFrameId); animationFrameId = requestAnimationFrame(step); }

      // ... Logique de la Modale d'Enregistrement (variables, open/close, setStatus, hhmmss, updateSendState) inchangée ...
      const btnRecord = $('#btnRecord'); const btnPause = $('#btnPause'); const btnResume = $('#btnResume'); const btnStop = $('#btnStop'); const btnReRecord = $('#btnReRecord'); const btnSend = $('#btnSend'); const meterBar = $('#meter'); const timerEl = $('#timer'); const player = $('#player'); const previewWrap = $('#previewWrap'); const transcriptionWrap = $('#transcriptionWrap'); const transcriptionText = $('#transcriptionText'); const fileInfo = $('#fileInfo');
      let mediaStream, mediaRecorder, audioChunks = [], audioBlob = null, audioUrl = null, mimeType = 'audio/webm'; let audioTranscription = ""; let startedAt = 0, pausedAt = 0, totalPausedTime = 0; let timerInterval = null; let audioContext, analyser, dataArray;
      function openModal(topic, trigger) { if (sending) { toast('Envoi...', 'warn'); return; } if (!currentMeta.consent || !currentMeta.studentCode || !currentMeta.cohort) { toast('Validez profil.', 'warn'); profileModal.classList.remove('hidden'); return; } currentTopic = topic; lastTrigger = trigger || null; $('#modalTheme').textContent = topic.charAt(0).toUpperCase() + topic.slice(1); $('#modalTitle').textContent = getQuestion(currentMeta.profile, topic); resetRecording(true); recordModal.classList.remove('hidden'); btnRecord.focus(); }
      function closeModal() { if (mediaRecorder && mediaRecorder.state !== 'inactive') { mediaRecorder.stop(); } mediaStream?.getTracks().forEach(track => track.stop()); recordModal.classList.add('hidden'); if (lastTrigger) lastTrigger.focus(); }
      if (modalClose) modalClose.addEventListener('click', closeModal); if (recordModal) recordModal.addEventListener('click', (e) => { if (e.target === recordModal) closeModal(); }); document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && recordModal && !recordModal.classList.contains('hidden')) { closeModal(); } });
      function setStatus(t) { if (statusEl) statusEl.textContent = t; }
      function hhmmss(s) { const sec = Math.max(0, Math.floor(s)); return `${String(Math.floor(sec / 60)).padStart(2, '0')}:${String(sec % 60).padStart(2, '0')}`; }
      function updateSendState() { const canSend = currentMeta.consent && !!audioBlob && !sending; if (btnSend) { btnSend.disabled = !canSend; btnSend.classList.toggle('btn-disabled', !canSend); } }

      // ... resetRecording inchangé ...
      function resetRecording(inModal = false) { mediaStream?.getTracks().forEach(t => t.stop()); mediaStream = null; if (mediaRecorder && mediaRecorder.state !== 'inactive') { try { mediaRecorder.stop(); } catch(e) {} } mediaRecorder = null; audioContext?.close().catch(e => {}); audioContext = null; clearInterval(timerInterval); timerInterval = null; audioChunks = []; audioBlob = null; audioTranscription = ""; if (audioUrl) { URL.revokeObjectURL(audioUrl); audioUrl = null; } startedAt = 0; pausedAt = 0; totalPausedTime = 0; if (inModal) { if(previewWrap) previewWrap.classList.add('hidden'); if ($('#controlsWrap')) $('#controlsWrap').classList.remove('hidden'); if(timerEl) timerEl.textContent = '00:00'; if(meterBar) meterBar.style.width = '0%'; if(btnRecord) btnRecord.classList.remove('hidden'); if(btnPause) btnPause.classList.add('hidden'); if(btnResume) btnResume.classList.add('hidden'); if(btnStop) btnStop.classList.add('hidden'); if(btnStop) btnStop.disabled = true; if(btnRecord) btnRecord.disabled = false; setStatus('Prêt'); updateSendState(); } }

      // ... Logique d'enregistrement (start, pause, resume, stop) inchangée ...
      if(btnRecord) btnRecord.addEventListener('click', startRecording); if(btnPause) btnPause.addEventListener('click', pauseRecording); if(btnResume) btnResume.addEventListener('click', resumeRecording); if(btnStop) btnStop.addEventListener('click', stopRecording); if(btnReRecord) btnReRecord.addEventListener('click', () => resetRecording(true));
      async function startRecording() { resetRecording(true); try { mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { noiseSuppression: true, echoCancellation: true } }); } catch (err) { let msg = 'Err micro.'; if (err.name === 'NotAllowedError') msg = 'Autorisation micro requise.'; else if (err.name === 'NotFoundError') msg = 'Aucun micro trouvé.'; toast(msg, 'err'); setStatus('Err micro'); return; } try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); analyser = audioContext.createAnalyser(); analyser.fftSize = 256; dataArray = new Uint8Array(analyser.frequencyBinCount); const source = audioContext.createMediaStreamSource(mediaStream); source.connect(analyser); const preferred = ["audio/webm;codecs=opus", "audio/webm", "audio/mp4", "audio/ogg;codecs=opus"]; mimeType = preferred.find(t => MediaRecorder.isTypeSupported?.(t)) || 'audio/webm'; mediaRecorder = new MediaRecorder(mediaStream, { mimeType }); mediaRecorder.ondataavailable = e => { if (e.data?.size > 0) audioChunks.push(e.data); }; mediaRecorder.onstart = () => { startedAt = Date.now(); totalPausedTime = 0; setStatus('Enregistrement…'); toast('Enregistrement démarré...'); btnRecord.classList.add('hidden'); btnPause.classList.remove('hidden'); btnResume.classList.add('hidden'); btnStop.classList.remove('hidden'); btnStop.disabled = false; if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { const elapsed = (Date.now() - startedAt - totalPausedTime) / 1000; const sec = Math.min(CONFIG.LIMITS.MAX_SECONDS, elapsed); if(timerEl) timerEl.textContent = hhmmss(sec); if (sec >= CONFIG.LIMITS.MAX_SECONDS) { stopRecording(); toast(`Temps max atteint.`, 'warn'); } if (analyser && dataArray && meterBar) { analyser.getByteTimeDomainData(dataArray); let sum = 0; for (let i = 0; i < dataArray.length; i++) { const v = (dataArray[i] - 128) / 128; sum += v * v; } const rms = Math.sqrt(sum / dataArray.length); meterBar.style.width = Math.min(100, Math.floor(rms * 200)) + "%"; } }, 80); }; mediaRecorder.onstop = () => { clearInterval(timerInterval); timerInterval = null; if (meterBar) meterBar.style.width = '0%'; audioBlob = new Blob(audioChunks, { type: mimeType }); if (audioBlob.size > CONFIG.LIMITS.MAX_BYTES) { toast(`Fichier trop gros.`, 'err'); resetRecording(true); return; } if (audioBlob.size < 1000) { toast('Trop court.', 'warn'); resetRecording(true); return; } audioUrl = URL.createObjectURL(audioBlob); if(player) player.src = audioUrl; if(previewWrap) previewWrap.classList.remove('hidden'); if ($('#controlsWrap')) $('#controlsWrap').classList.add('hidden'); if(fileInfo && timerEl) fileInfo.textContent = `${mimeType}, ${(audioBlob.size / 1024).toFixed(1)} KB, durée: ${timerEl.textContent}`; setStatus('Prêt à l’envoi'); audioTranscription = "[CLIENT_TRANSCRIPTION_DISABLED]"; updateSendState(); mediaStream?.getTracks().forEach(t => t.stop()); mediaStream = null; audioContext?.close().catch(e => {}); audioContext = null; }; mediaRecorder.onerror = (event) => { console.error(`Err MediaRecorder: ${event.error.name}`, event.error); toast(`Err enregistrement: ${event.error.message}`, 'err'); setStatus('Err rec'); resetRecording(true); }; mediaRecorder.start(); } catch (err) { console.error("Err init rec:", err); toast("Impossible démarrer.", 'err'); setStatus('Err init'); resetRecording(true); } }
      function pauseRecording() { if (mediaRecorder?.state === 'recording') { mediaRecorder.pause(); pausedAt = Date.now(); clearInterval(timerInterval); timerInterval = null; setStatus('En pause'); if(btnPause) btnPause.classList.add('hidden'); if(btnResume) btnResume.classList.remove('hidden'); } }
      function resumeRecording() { if (mediaRecorder?.state === 'paused') { mediaRecorder.resume(); totalPausedTime += (Date.now() - pausedAt); pausedAt = 0; setStatus('Enregistrement…'); if(btnPause) btnPause.classList.remove('hidden'); if(btnResume) btnResume.classList.add('hidden'); if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { const elapsed = (Date.now() - startedAt - totalPausedTime) / 1000; const sec = Math.min(CONFIG.LIMITS.MAX_SECONDS, elapsed); if (timerEl) timerEl.textContent = hhmmss(sec); if (sec >= CONFIG.LIMITS.MAX_SECONDS) stopRecording(); if (analyser && dataArray && meterBar) { analyser.getByteTimeDomainData(dataArray); let sum = 0; for(let i=0;i<dataArray.length;i++){ const v=(dataArray[i]-128)/128; sum+=v*v; } const rms=Math.sqrt(sum/dataArray.length); meterBar.style.width=Math.min(100,Math.floor(rms*200))+"%"; } }, 80); } }
      function stopRecording() { if (mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')) { mediaRecorder.stop(); toast('Enregistrement arrêté.'); if(btnRecord) btnRecord.classList.remove('hidden'); if(btnPause) btnPause.classList.add('hidden'); if(btnResume) btnResume.classList.add('hidden'); if(btnStop) btnStop.classList.add('hidden'); if(btnStop) btnStop.disabled = true; if(btnRecord) btnRecord.disabled = false; } }

      // ... fetchGAS et blobToBase64 inchangés ...
      async function fetchGAS(url, payload) { if (!url || url.startsWith("https://script.google.com")===false) throw new Error("Backend URL invalide."); try { const response = await fetch(url, { method: 'POST', mode: 'cors', credentials: 'omit', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload), redirect: 'follow' }); if (!response.ok) { let errorText = `Erreur réseau: ${response.statusText} (${response.status})`; try { const errJson = await response.json(); if (errJson?.error) errorText = `Erreur backend: ${errJson.error}`; } catch(e) {} throw new Error(errorText); } return response.json(); } catch (err) { console.error("Erreur fetchGAS:", err); throw new Error("Communication serveur échouée."); } }
      function blobToBase64(blob) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => { try { const base64 = reader.result.split(',')[1]; if (!base64) throw new Error("Conv Base64 invalide."); resolve(base64); } catch (err) { reject(err); } }; reader.onerror = reject; reader.readAsDataURL(blob); }); }

      if(btnSend) btnSend.addEventListener('click', submitOne);

      // --- CORRECTION DE LA FONCTION SUBMITONE ---
      /** Envoie la réponse finale. */
      async function submitOne() {
        // ... (Début inchangé : vérification sending, setStatus, toast...) ...
        if (sending || !audioBlob) {
           console.warn("submitOne: Ignoré (envoi déjà en cours ou pas d'audioBlob)");
           return;
        }
        sending = true;
        setStatus('Préparation envoi...');
        if (modalClose) modalClose.disabled = true;
        if (btnReRecord) btnReRecord.disabled = true; btnReRecord.classList.add('btn-disabled');
        updateSendState();
        toast('Envoi de votre réponse...');

        try {
          // ... (préparation du payload, logging, etc. inchangés) ...
          const fileBase64 = await blobToBase64(audioBlob);
          const [mm, ss] = timerEl ? timerEl.textContent.split(':').map(Number) : [0, 0];
          const durationSec = (mm * 60 + ss) || 0;
          const payload = {
             action: "uploadAudio", ...currentMeta, topic: currentTopic,
             durationSec: durationSec, mimeType: mimeType,
             transcription: "[CLIENT_TRANSCRIPTION_DISABLED]",
             fileBase64: fileBase64, clientUA: navigator.userAgent
          };
          console.log("----------------------------------------");
          console.log("Frontend: Envoi du payload à", CONFIG.WEBAPP_URL);
          console.log("MimeType envoyé:", payload.mimeType);

          setStatus('Envoi en cours...');

          // Appel au backend - On vérifie juste si la connexion réussit (HTTP 200 OK)
          const response = await fetch(CONFIG.WEBAPP_URL, {
            method: 'POST', mode: 'cors', credentials: 'omit',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(payload), redirect: 'follow'
          });

          // Si la réponse N'EST PAS OK (erreur réseau, 4xx, 5xx)
          if (!response.ok) {
              let errorText = `Erreur réseau ${response.status}: ${response.statusText}`;
              try { const bodyText = await response.text(); console.error("Réponse d'erreur brute du backend:", bodyText); const errJson = JSON.parse(bodyText); if (errJson && errJson.error) { errorText = errJson.error; } else if (bodyText) { errorText = bodyText.slice(0, 100); } } catch(e) { console.warn("Impossible de lire/parser le corps de la réponse d'erreur"); }
              throw new Error(errorText); // Lancer l'erreur pour le bloc catch
          }

          // Si on arrive ici, la réponse était HTTP 200 OK = SUCCÈS pour l'utilisateur
          console.log("Frontend: Communication avec le backend réussie (HTTP 200 OK).");
          setStatus('Terminé ✅');
          toast('Réponse envoyée !', 'ok');

          // Mise à jour locale (identique à avant)
          currentStatus[currentTopic] = { done: true, at: new Date().toISOString(), durationSec: durationSec };
          saveStatus(currentMeta.studentCode, currentStatus);
          renderAllCards();
          // closeModal(); // Déplacé dans finally

        } catch (err) { // Attrape les erreurs fetch OU si response.ok était false
          console.error('Erreur finale dans submitOne:', err);
          toast(`Erreur d’envoi : ${err.message}. Réessayez.`, 'err');
          setStatus('Erreur d’envoi');
          // On ne ferme PAS la modale ici

        } finally { // S'exécute TOUJOURS (succès ou erreur)
          sending = false;
          if (modalClose) modalClose.disabled = false;
          if (btnReRecord) btnReRecord.disabled = false; btnReRecord.classList.remove('btn-disabled');
          updateSendState();
          console.log("------------------- submitOne terminé (finally) --------------------");
          // On ferme la modale ICI
          closeModal();
        }
         // PAS de deuxième catch/finally ici !
      } // Fin de submitOne


      // --- Démarrage ---
      initProfile(); // Lancer l'initialisation
      console.log("Initialisation terminée.");

    }); // Fin de DOMContentLoaded
  </script>
</body>
</html>
}
